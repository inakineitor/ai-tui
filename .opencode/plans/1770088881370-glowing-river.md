# Fix CI/CD npm Trusted Publishing Authentication

## Problem Summary

The release workflow at `.github/workflows/release.yml` is failing with:

```
ENEEDAUTH This command requires you to be logged in to https://registry.npmjs.org/
```

**Root Cause**: The `changesets/action@v1` always creates a `.npmrc` file with `NPM_TOKEN` authentication, which blocks npm's OIDC auto-detection feature. Since you've set up npm trusted publishing (OIDC), the token-based approach conflicts with the OIDC workflow.

## Solution

Use the fork `GarthDB/changesets-action@v1.6.9` which adds an `oidcAuth` parameter that:
- Skips `.npmrc` creation when enabled
- Allows npm CLI to auto-detect OIDC environment
- Properly supports npm trusted publishing

## Required Changes to `.github/workflows/release.yml`

### 1. Add OIDC permissions at the job level

```yaml
permissions:
  id-token: write      # Required for OIDC trusted publishing
  contents: write      # Required for changesets to create PRs/releases
  pull-requests: write # Required for changesets to create PRs
```

### 2. Add `registry-url` to the `setup-node` action

```yaml
- name: Setup Node.js 24.x
  uses: actions/setup-node@v4
  with:
    node-version: 24.x
    registry-url: 'https://registry.npmjs.org'
```

### 3. Switch to the OIDC-enabled fork and enable `oidcAuth`

```yaml
- name: Create Release Pull Request or Publish to npm
  id: changesets
  uses: GarthDB/changesets-action@v1.6.9
  with:
    publish: pnpm release
    createGithubReleases: true
    oidcAuth: true
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    # No NPM_TOKEN needed!
```

## Final Workflow File

```yaml
name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup pnpm 10
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js 24.x
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        run: pnpm i

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: GarthDB/changesets-action@v1.6.9
        with:
          publish: pnpm release
          createGithubReleases: true
          oidcAuth: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## npm Trusted Publisher Configuration Checklist

Ensure the following is configured on npmjs.com for the `@ai-tui/core` package:

1. Go to https://www.npmjs.com/package/@ai-tui/core/access (Settings tab)
2. Under "Trusted Publisher", select "GitHub Actions"
3. Configure:
   - **Organization or user**: `inakineitor`
   - **Repository**: `ai-tui`
   - **Workflow filename**: `release.yml`
4. Optionally enable "Require two-factor authentication and disallow tokens" for enhanced security

## Verification

After applying the fix:

1. Push the changes to `main`
2. Monitor the GitHub Actions run at: https://github.com/inakineitor/ai-tui/actions
3. The workflow should successfully authenticate via OIDC and publish `@ai-tui/core@0.0.3`
4. Verify the package appears on npm with provenance badge: https://www.npmjs.com/package/@ai-tui/core

## Files to Modify

- `.github/workflows/release.yml` - Update workflow for OIDC trusted publishing

## Key Changes Summary

| Before | After |
|--------|-------|
| `changesets/action@v1` | `GarthDB/changesets-action@v1.6.9` |
| `NPM_TOKEN: ${{ secrets.NPM_TOKEN }}` | `oidcAuth: true` (no token needed) |
| No permissions block | `permissions: { id-token: write, contents: write, pull-requests: write }` |
| No registry-url | `registry-url: 'https://registry.npmjs.org'` |
