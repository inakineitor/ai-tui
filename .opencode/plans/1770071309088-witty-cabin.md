# Fix Ultracite Linting Issues in packages/core/

## Summary

Fix **195 linting issues** in `packages/core/` based on user preferences.

## Issues Breakdown

| Category | Count | Resolution |
|----------|-------|------------|
| `useConsistentTypeDefinitions` | 133 | Configure rule to prefer `type`, then auto-fix |
| `noExplicitAny` | 28 | Add `biome-ignore` comments on each line |
| `noNestedTernary` | 14 | Disable rule in `biome.jsonc` |
| `noUndeclaredVariables` (Bun) | 9 | Add Bun types reference |
| `noExcessiveCognitiveComplexity` | 8 | Add `biome-ignore` comments |
| `noBitwiseOperators` | 3 | Add `biome-ignore` comments |

---

## Implementation Plan

### 1. Update `biome.jsonc` Configuration

**File:** `/biome.jsonc`

Configure `useConsistentTypeDefinitions` to prefer `type` and disable `noNestedTernary`:

```jsonc
{
  "linter": {
    "rules": {
      "correctness": {
        "noUnusedImports": "off"
      },
      "style": {
        "useConsistentTypeDefinitions": {
          "level": "error",
          "options": {
            "style": "type"
          }
        },
        "noNestedTernary": "off"
      }
    }
  }
}
```

### 2. Auto-fix Type Definitions

After updating the config, run:

```bash
pnpm dlx ultracite fix packages/core/
```

This will automatically convert all 133 `interface` declarations to `type` aliases.

---

### 3. Install `@types/bun` Package

Install the official Bun types package:

```bash
pnpm add -D @types/bun --filter @opencode/core
```

TypeScript automatically loads `@types/*` packages, so the `Bun` global will be recognized immediately. No tsconfig or triple-slash changes needed.

---

### 4. Add `biome-ignore` Comments for `noExplicitAny` (28 locations)

Files requiring ignore comments:

- `packages/core/src/types.ts` - Multiple `any` usages in generic constraints
- `packages/core/src/context/session.tsx` - Session-related types
- `packages/core/src/routes/session/components/message-list/components/message/index.tsx`
- Other files with `any` usage

**Comment format:**
```typescript
// biome-ignore lint/suspicious/noExplicitAny: <reason>
```

---

### 5. Add `biome-ignore` Comments for Complex Functions (8 locations)

| File | Function | Complexity |
|------|----------|------------|
| `components/dialog/components/select.tsx` | `useKeyboard` callback | 30 |
| `components/prompt/components/autocomplete.tsx` | `onInput` | 51 |
| `components/prompt/components/autocomplete.tsx` | `onKeyDown` | 45 |
| `components/prompt/index.tsx` | `handleSubmit` | 24 |
| `components/prompt/index.tsx` | `handleKeyDown` | 53 |
| `components/prompt/index.tsx` | `handlePaste` | 29 |
| + 2 more locations (to be identified) |

**Comment format:**
```typescript
// biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex input handling logic
```

---

### 6. Add `biome-ignore` Comments for Bitwise Operators (3 locations)

**File:** `packages/core/src/lib/detect-terminal-mode.ts:51-53`

```typescript
// biome-ignore lint/suspicious/noBitwiseOperators: Intentional 16-bit to 8-bit color conversion
r = Number.parseInt(parts[0] ?? "0", 16) >> 8;
// biome-ignore lint/suspicious/noBitwiseOperators: Intentional 16-bit to 8-bit color conversion
g = Number.parseInt(parts[1] ?? "0", 16) >> 8;
// biome-ignore lint/suspicious/noBitwiseOperators: Intentional 16-bit to 8-bit color conversion
b = Number.parseInt(parts[2] ?? "0", 16) >> 8;
```

---

## Verification

After all changes:

```bash
pnpm dlx ultracite check packages/core/
```

Expected result: **0 errors**

---

## Files to Modify

1. `/biome.jsonc` - Configure `useConsistentTypeDefinitions` to prefer `type`, disable `noNestedTernary`
2. `packages/core/package.json` - Add `@types/bun` dev dependency
3. `packages/core/src/lib/detect-terminal-mode.ts` - Add biome-ignore for bitwise
4. `packages/core/src/types.ts` - Add biome-ignore for any types
5. `packages/core/src/context/session.tsx` - Add biome-ignore for any types
6. `packages/core/src/components/dialog/components/select.tsx` - Add biome-ignore for complexity
7. `packages/core/src/components/prompt/components/autocomplete.tsx` - Add biome-ignore for complexity
8. `packages/core/src/components/prompt/index.tsx` - Add biome-ignore for complexity
9. Additional files with `any` usages (to be identified during implementation)

## Execution Order

1. Update `biome.jsonc` config
2. Run `ultracite fix` to auto-convert interfaces to types
3. Add Bun types reference
4. Add all `biome-ignore` comments
5. Run final verification
