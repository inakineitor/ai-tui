# Plan: Replace Bun in @packages/core

## Summary

Replacing Bun in `@packages/core` requires modifying **2 files** that use Bun-specific APIs and updating package configuration. The total Bun-specific code is localized and relatively small.

---

## Current Bun Usage

### Files with Bun-Specific Code

| File | Bun APIs Used |
|------|---------------|
| `src/lib/clipboard.ts` | `$` (shell), `Bun.file()`, `Bun.which()`, `Bun.spawn()` |
| `src/components/prompt/index.tsx` | `Bun.file()` |

### Package Configuration

- `package.json`: `@types/bun` devDependency, `bun >= 1.1.0` in engines

---

## Required Changes

### 1. Replace `clipboard.ts` Bun APIs

**Current Bun APIs â†’ Node.js Equivalents:**

| Bun API | Node.js Replacement | Notes |
|---------|---------------------|-------|
| `$ (bun shell)` | `execa` or `child_process.exec` | execa provides cleaner API similar to Bun's $ |
| `Bun.file()` | `fs.readFile()` / `fs.promises.readFile()` | Direct replacement |
| `Bun.which()` | `which` npm package | Or manual PATH search |
| `Bun.spawn()` | `child_process.spawn()` | Native Node.js |

**Specific replacements in clipboard.ts:**

```typescript
// BEFORE: Bun shell
import { $ } from "bun"
await $`osascript -e '...'`.nothrow().quiet()

// AFTER: execa
import { execa } from "execa"
await execa('osascript', ['-e', '...'], { reject: false })
```

```typescript
// BEFORE: Bun.file
const data = await Bun.file(tmpfile).arrayBuffer()

// AFTER: Node fs
import { readFile } from "node:fs/promises"
const data = await readFile(tmpfile)
```

```typescript
// BEFORE: Bun.which
if (await Bun.which("wl-copy")) { ... }

// AFTER: which package
import which from "which"
if (await which("wl-copy", { nothrow: true })) { ... }
```

```typescript
// BEFORE: Bun.spawn with stdin pipe
const proc = Bun.spawn(["wl-copy"], { stdin: "pipe", stdout: "ignore" })
proc.stdin.write(data)
proc.stdin.end()
await proc.exited

// AFTER: Node child_process.spawn
import { spawn } from "node:child_process"
const proc = spawn("wl-copy", [], { stdio: ["pipe", "ignore", "ignore"] })
proc.stdin.write(data)
proc.stdin.end()
await new Promise(resolve => proc.on("close", resolve))
```

### 2. Replace `prompt/index.tsx` Bun APIs

**Lines 771-795:** Replace `Bun.file()` with Node.js fs:

```typescript
// BEFORE
const file = Bun.file(filepath)
const mimeType = file.type
const content = await file.text()
const buffer = await file.arrayBuffer()

// AFTER
import { readFile, stat } from "node:fs/promises"
import { basename } from "node:path"
import mime from "mime-types" // or file-type package

const content = await readFile(filepath, "utf-8")
const buffer = await readFile(filepath)
const mimeType = mime.lookup(filepath) || "application/octet-stream"
const fileName = basename(filepath)
```

### 3. Update package.json

```diff
  "devDependencies": {
-   "@types/bun": "^1.3.6",
+   "@types/node": "^22.0.0",
  },
  "dependencies": {
+   "execa": "^9.0.0",
+   "which": "^4.0.0",
+   "mime-types": "^2.1.35"
  },
  "engines": {
-   "bun": ">=1.1.0"
+   "node": ">=20.0.0"
  }
```

---

## New Dependencies Required

| Package | Purpose | Size |
|---------|---------|------|
| `execa` | Shell command execution (replaces `$`) | ~50KB |
| `which` | Find executables in PATH (replaces `Bun.which()`) | ~5KB |
| `mime-types` | MIME type detection (replaces `BunFile.type`) | ~20KB |

**Alternative:** Could use only Node.js built-ins (`child_process`, manual PATH lookup, manual MIME detection) to avoid dependencies, but execa provides a much cleaner API.

---

## Files to Modify

1. `packages/core/src/lib/clipboard.ts` - Major refactor
2. `packages/core/src/components/prompt/index.tsx` - Minor changes (~20 lines)
3. `packages/core/package.json` - Dependency updates

---

## Verification

1. Run type checker: `pnpm tsc --noEmit` in packages/core
2. Run linter: `pnpm dlx ultracite check`
3. Test clipboard operations manually:
   - Copy text to clipboard
   - Copy image to clipboard
   - Read clipboard content
4. Test file paste in prompt:
   - Paste a file path into the prompt
   - Verify text files are read correctly
   - Verify images are detected and processed

---

## Considerations

### Option A: Use execa (Recommended)
- Cleaner API, similar to Bun's `$`
- Well-maintained, widely used
- Adds ~50KB dependency

### Option B: Pure Node.js built-ins
- No additional dependencies
- More verbose code
- Manual error handling for shell commands

**Recommendation:** Use execa for maintainability. The dependency size is minimal and the code will be much cleaner.
